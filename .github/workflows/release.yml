name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
  workflow_call:
    inputs:
      tag:
        description: "Release tag (e.g., v0.1.0)"
        required: true
        type: string

permissions:
  contents: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  ci:
    name: CI check
    uses: ./.github/workflows/rust.yml

  build:
    name: Build ${{ matrix.target }}
    needs: ci
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            use_cross: false
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            use_cross: false
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache build artifacts
        if: ${{ !matrix.use_cross }}
        uses: actions/cache@v4
        with:
          path: target/
          key: ${{ runner.os }}-cargo-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cross binary
        if: matrix.use_cross
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cross
          key: ${{ runner.os }}-cross-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cross
        if: matrix.use_cross
        run: |
          if [ ! -f ~/.cargo/bin/cross ]; then
            cargo install cross --locked
          fi

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --locked --target ${{ matrix.target }}
          else
            cargo build --release --locked --target ${{ matrix.target }}
          fi

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../seite-${{ matrix.target }}.tar.gz seite
          cd ../../..

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target/${{ matrix.target }}/release/seite.exe" -DestinationPath "seite-${{ matrix.target }}.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: seite-${{ matrix.target }}
          path: |
            seite-${{ matrix.target }}.tar.gz
            seite-${{ matrix.target }}.zip

  release:
    name: Create release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum seite-*.tar.gz seite-*.zip 2>/dev/null > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: |
            artifacts/seite-*.tar.gz
            artifacts/seite-*.zip
            artifacts/checksums-sha256.txt

  # TODO: Enable SLSA provenance when repo is public
  # provenance:
  #   name: SLSA provenance
  #   needs: release
  #   permissions:
  #     actions: read
  #     id-token: write
  #     contents: write
  #   uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
  #   with:
  #     base64-subjects: "${{ needs.release.outputs.digests }}"
  #     upload-assets: true

  deploy-site:
    name: Deploy docs site
    needs: [build, release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/download-artifact@v4
        with:
          name: seite-x86_64-unknown-linux-gnu
          path: artifacts

      - name: Install seite from release artifact
        run: |
          tar xzf artifacts/seite-x86_64-unknown-linux-gnu.tar.gz -C artifacts
          chmod +x artifacts/seite
          sudo mv artifacts/seite /usr/local/bin/seite
          seite --version

      - name: Build docs site
        working-directory: seite-sh
        run: seite build

      - name: Generate download routing files
        working-directory: seite-sh
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          # version.txt — latest version pointer
          echo "$TAG" > dist/version.txt

          # _redirects — route /download/ paths to GitHub Releases
          # First rule: /download/latest/* resolves to the current release
          # Second rule: /download/<version>/* passes through to any release
          printf '/download/latest/* https://github.com/seite-sh/seite/releases/download/%s/:splat 302\n' "$TAG" > dist/_redirects
          printf '/download/* https://github.com/seite-sh/seite/releases/download/:splat 302\n' >> dist/_redirects

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name seite-sh
          workingDirectory: seite-sh
